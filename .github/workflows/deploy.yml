deploy:
  needs: build-and-test
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Start SSH Agent and Add Key (Proper Formatting)
      run: |
        eval "$(ssh-agent -s)"
        echo -e "${{ secrets.AWS_SSH_KEY }}" | tr -d '\r' | ssh-add -
        ssh-add -l  # Debugging: Check if key is added

    - name: Debug SSH Connection
      run: |
        echo "üîç Checking SSH Configuration..."
        echo "EC2 IP: ${{ secrets.AWS_EC2_IP }}"
        echo "SSH User: ${{ secrets.SSH_USER }}"
        ssh -vvv -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.AWS_EC2_IP }} "echo '‚úÖ SSH Connected Successfully'"

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.AWS_EC2_IP }} << 'EOF'
          echo "üöÄ Connected to EC2"
          cd /home/ec2-user
          echo "üóë Removing old project..."
          rm -rf YPClub-backend
          echo "üì• Cloning latest repo..."
          git clone https://github.com/your-github-user/YPClub-backend.git
          cd YPClub-backend
          echo "üõë Stopping old containers..."
          docker-compose down
          echo "üöÄ Starting new containers..."
          docker-compose up --build -d
          echo "‚úÖ Deployment complete!"
        EOF