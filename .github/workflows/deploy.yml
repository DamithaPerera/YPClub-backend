deploy:
  needs: build-and-test
  runs-on: ubuntu-latest
  steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Start SSH Agent and Add Key
      run: |
        eval "$(ssh-agent -s)"
        echo "${{ secrets.AWS_SSH_KEY }}" | ssh-add -
        ssh-add -l  # Debug: List added keys

    - name: Test SSH Connection
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.AWS_EC2_IP }} "echo 'SSH Connected Successfully'"

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.AWS_EC2_IP }} << 'EOF'
          echo "Connected to EC2"
          cd /home/ec2-user
          echo "Removing old project..."
          rm -rf YPClub-backend
          echo "Cloning latest repo..."
          git clone https://github.com/your-github-user/YPClub-backend.git
          cd YPClub-backend
          echo "Stopping old containers..."
          docker-compose down
          echo "Starting new containers..."
          docker-compose up --build -d
          echo "Deployment complete!"
        EOF
